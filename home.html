<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Painel Administrativo</title>

  <style>
    body {
      display: none;
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    h1 {
      margin: 0;
    }

    button {
      padding: 8px 14px;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      font-weight: bold;
    }

    .btn-logout {
      background: #e74c3c;
      color: #fff;
    }

    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .box {
      background: #fff;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .box h2 {
      margin-top: 0;
      border-bottom: 1px solid #ddd;
      padding-bottom: 8px;
    }

    .comentario {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }

    .comentario strong {
      display: block;
    }

    .acoes {
      margin-top: 8px;
    }

    .acoes button {
      margin-right: 6px;
      font-size: 12px;
    }

    .btn-aprovar {
      background: #2ecc71;
      color: #fff;
    }

    .btn-remover {
      background: #f39c12;
      color: #fff;
    }

    .btn-excluir {
      background: #c0392b;
      color: #fff;
    }

    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>Painel de Comentários</h1>
  <button id="btnLogout" class="btn-logout">Sair</button>
</header>

<div class="container">
  <div class="box">
    <h2>Comentários não postados</h2>
    <div id="comentariosPendentes"></div>
  </div>

  <div class="box">
    <h2>Comentários postados</h2>
    <div id="comentariosAprovados"></div>
  </div>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<script>
  // Configuração do Supabase
  const supabaseUrl = "https://uqhuqyyzygzisohwkyeu.supabase.co";
  const supabaseKey = "sb_publishable_JxPXj6Vyt7z_Jj_SPofMOw_Gsmk3hMW";
  const client = supabase.createClient(supabaseUrl, supabaseKey);

  // Verifica se o usuário está logado
  async function checkUser() {
    const { data, error } = await client.auth.getUser();
    if (error) {
      console.error("Erro ao verificar usuário:", error);
      alert("Erro ao verificar usuário.");
      return;
    }

    if (!data.user) {
      window.location.href = "/login/index.html";
    } else {
      document.body.style.display = "block";
      carregarComentarios();
    }
  }

  // Logout
  async function logout() {
    const { error } = await client.auth.signOut();
    if (error) {
      console.error("Erro ao sair:", error);
      alert("Não foi possível sair.");
      return;
    }
    window.location.href = "/login/index.html";
  }

  document.getElementById("btnLogout").addEventListener("click", logout);

  // Carrega todos os comentários
  async function carregarComentarios() {
    await carregarPendentes();
    await carregarAprovados();
  }

  // Comentários pendentes (aprovado = false)
  async function carregarPendentes() {
    const { data, error } = await client
      .from("comentarios")
      .select("*")
      .eq("aprovado", false)
      .order("id", { ascending: false });

    if (error) {
      console.error("Erro ao carregar comentários pendentes:", error);
      return;
    }

    const lista = document.getElementById("comentariosPendentes");
    lista.innerHTML = "";

    data.forEach(c => {
      lista.innerHTML += `
        <div class="comentario">
          <strong>${c.nome} (${c.estrelas}★)</strong>
          <p>${c.mensagem}</p>
          <div class="acoes">
            <button class="btn-aprovar" onclick="aprovar(${c.id})">Aprovar</button>
            <button class="btn-excluir" onclick="excluir(${c.id})">Excluir</button>
          </div>
        </div>
      `;
    });
  }

  // Comentários aprovados (aprovado = true)
  async function carregarAprovados() {
    const { data, error } = await client
      .from("comentarios")
      .select("*")
      .eq("aprovado", true)
      .order("id", { ascending: false });

    if (error) {
      console.error("Erro ao carregar comentários aprovados:", error);
      return;
    }

    const lista = document.getElementById("comentariosAprovados");
    lista.innerHTML = "";

    data.forEach(c => {
      lista.innerHTML += `
        <div class="comentario">
          <strong>${c.nome} (${c.estrelas}★)</strong>
          <p>${c.mensagem}</p>
          <div class="acoes">
            <button class="btn-remover" onclick="desaprovar(${c.id})">Ocultar</button>
            <button class="btn-excluir" onclick="excluir(${c.id})">Excluir</button>
          </div>
        </div>
      `;
    });
  }

  // Aprovar comentário
  async function aprovar(id) {
    const { error } = await client
      .from("comentarios")
      .update({ aprovado: true })
      .eq("id", id);

    if (error) {
      console.error("Erro ao aprovar comentário:", error);
      alert("Não foi possível aprovar o comentário.");
      return;
    }

    await carregarComentarios();
  }

  // Desaprovar comentário
  async function desaprovar(id) {
    const { error } = await client
      .from("comentarios")
      .update({ aprovado: false })
      .eq("id", id);

    if (error) {
      console.error("Erro ao ocultar comentário:", error);
      alert("Não foi possível ocultar o comentário.");
      return;
    }

    await carregarComentarios();
  }

  // Excluir comentário
  async function excluir(id) {
    const confirmar = confirm("Tem certeza que deseja excluir este comentário?");
    if (!confirmar) return;

    const { error } = await client
      .from("comentarios")
      .delete()
      .eq("id", id);

    if (error) {
      console.error("Erro ao excluir comentário:", error);
      alert("Não foi possível excluir o comentário.");
      return;
    }

    await carregarComentarios();
  }

  // Inicia o painel
  checkUser();
</script>



</body>
</html>
